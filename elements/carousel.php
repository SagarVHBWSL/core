<?php
/**
 * FIXME: Edit Title Content
 *
 * FIXME: Edit Description Content
 *
 * Please do not edit this file. This file is part of the Cyber Chimps Framework and all modifications
 * should be made in a child theme.
 * FIXME: POINT USERS TO DOWNLOAD OUR STARTER CHILD THEME AND DOCUMENTATION
 *
 * @category Cyber Chimps Framework
 * @package  Framework
 * @since    1.0
 * @author   CyberChimps
 * @license  http://www.opensource.org/licenses/gpl-license.php GPL v2.0 (or later)
 * @link     http://www.cyberchimps.com/
 */

// Don't load directly
if ( !defined('ABSPATH') ) { die('-1'); }

if ( !class_exists( 'CyberChimpsCarousel' ) ) {
	class CyberChimpsCarousel {
		
		protected static $instance;
		public $options;
		
		/* Static Singleton Factory Method */
		public static function instance() {
			if (!isset(self::$instance)) {
				$className = __CLASS__;
				self::$instance = new $className;
			}
			return self::$instance;
		}
		
		/**
		 * Initializes plugin variables and sets up WordPress hooks/actions.
		 *
		 * @return void
		 */
		protected function __construct( ) {
			add_action( 'carousel_section', array( $this, 'render_display' ) );
			$this->options = get_option( 'cyberchimps_options' );
		}
		
		// TODO: Fix documentation
		public function render_display() { 
			$default = get_template_directory_uri() . '/core/lib/images/carousel.jpg';
			$out = '';
			
			//HS Set Loop variables
			$i = 1;
			$x = 0;

			if ( is_page() ) {
				$customcategory = get_post_meta($post->ID, 'carousel_category' , true);
			}
			else {
				$customcategory_obj = get_term( $this->options['carousel_categories'], 'carousel_categories' );
				$customcategory = $customcategory_obj->name;
			}
			?>
			<div class="row-fluid">
				<div class="carousel slide" id="cc-carousel" data-pause="">
        	<div class="carousel-inner">
						<?php
						
						$args = array(
							'numberposts'     => 50,
							'offset'          => 0,
							'carousel_categories'        => $customcategory,
							'orderby'         => 'post_date',
							'order'           => 'DESC',
							'post_type'       => 'featured_posts',
							'post_status'     => 'publish');
						
						// HS set total posts so the loop can be finished correctly, this needs to be changed when we use get_posts()
    				$carousel_posts = get_posts( $args );
		
						if ( $carousel_posts ) :
							
							foreach( $carousel_posts as $post ):
								
								// HS on the first loop through we add the active class
								if( $i == 1 && $x == 0 ) {
									$out .= '<div class="active item">';
									$out .= '<ul class="thumbnails>';
								}
								// HS after 6 loops through this is called to start a new 6 items but without active class
								elseif ( $i == 1 && $x > 0 ) {
									$out .= '<div class="active item">';
									$out .= '<ul class="thumbnails>';
								}									
							
								
								
								/* Post-specific variables */
								$image = get_post_meta($post->ID, 'post_image', true);
								$link = get_post_meta($post->ID, 'post_url', true);
								$title = $post->post_title;
								
								if ($image == '') {
									$image = $default;
								}
								
								$out .= '<li class="span2">';
								$out .= '<a href="'.$link.'"><img src="'.$image.'" alt="'.$title.'" /></a>';
								$out .= '<div class="carousel_caption">'.$title.'</div>';
								$out .= '</li>';
							
							// HS after 6 loops through or after all items have been listed we close the ul and div tags
							if( $i == 6 || ( $x * 6 + $i )  == 20 ) {
								$out .= '</ul>';
								$out .= '</div>';
								$i = 1;
								$x++;
							}
							else {
								$i++;
							}							
							
							endforeach;	
							
						else :
							$out .= '<div class="active item">';
							$out .= '<ul class="thumbnails">';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 1"/></a>';
							$out .= '<div class="caption"><h3>Test 1</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 2"/></a>';
							$out .= '<div class="caption"><h3>Test 2</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 3"/></a>';
							$out .= '<div class="caption"><h3>Test 3</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 4"/></a>';
							$out .= '<div class="caption"><h3>Test 4</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 5"/></a>';
							$out .= '<div class="caption"><h3>Test 5</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 6"/></a>';
							$out .= '<div class="caption"><h3>Test 6</h3></div>';
							$out .= '</li>';
							$out .= '</ul>';
							$out .= '</div>';
							$out .= '<div class="item">';
							$out .= '<ul class="thumbnails">';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 7"/></a>';
							$out .= '<div class="caption"><h3>Test 7</h3></div>';
							$out .= '</li>';
							$out .= '<li class="span2">';
							$out .= '<a href="#"><img src="'.$default.'" alt="Post 8"/></a>';
							$out .= '<div class="caption"><h3>Test 8</h3></div>';
							$out .= '</li>';
							$out .= '</ul>';
						endif;
						
						echo $out;
						?>
			</div>
          </div><!-- carousel -->
			
        <a class="carousel-control left" href="#cc-carousel" data-slide="prev">&lsaquo;</a>
				<a class="carousel-control right" href="#cc-carousel" data-slide="next">&rsaquo;</a>
				</div><!-- carousel-container -->
			</div><!-- row-fluid -->
			<?php
		}
	}
}
CyberChimpsCarousel::instance();